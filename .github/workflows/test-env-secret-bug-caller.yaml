---
name: Test Environment Secret Bug (Caller)

# This workflow CALLS the reusable workflow to demonstrate the bug
# The bug only appears when using workflow_call, not direct triggers

'on':
  pull_request:
    paths:
      - '.github/workflows/test-env-secret-bug*.yaml'
      - 'GITHUB_ACTIONS_SECRET_BUG.md'
  workflow_dispatch:

jobs:
  # Test both scenarios using the REUSABLE workflow
  test-reusable-workflow:
    strategy:
      fail-fast: false
      matrix:
        suite: ['networking', 'object_storage']
    uses: ./.github/workflows/test-env-secret-bug-reusable.yaml
    with:
      suite: ${{ matrix.suite }}
    secrets: inherit

  # For comparison: Test with DIRECT workflow (non-reusable)
  test-direct-workflow:
    runs-on: cw
    container: ghcr.io/coreweave/github-actions-images/github-base-runner:v1.15.0
    environment: QA
    strategy:
      fail-fast: false
      matrix:
        suite: ['networking', 'object_storage']
    env:
      TEST_ENDPOINT: ${{ matrix.suite == 'object_storage' && secrets.COREWEAVE_OBJS_API_ENDPOINT || vars.COREWEAVE_API_ENDPOINT }}
      TEST_TOKEN: ${{ matrix.suite == 'object_storage' && secrets.COREWEAVE_OBJS_API_TOKEN || secrets.COREWEAVE_API_TOKEN }}
    steps:
      - name: Test ternary in DIRECT workflow (for comparison)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Testing suite: ${{ matrix.suite }} (DIRECT workflow)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ This is a DIRECT workflow (not workflow_call)"
          echo "   Direct workflows should work fine!"
          echo ""
          echo "ğŸ“Š Results:"
          echo ""
          echo "Environment SECRET (TEST_TOKEN):"
          if [ -n "$TEST_TOKEN" ]; then
            echo "  Set: âœ… YES"
            echo "  Length: ${#TEST_TOKEN} chars"
            echo ""
            echo "âœ… EXPECTED: Direct workflows work correctly"
          else
            echo "  Set: âŒ NO"
            echo ""
            echo "âŒ UNEXPECTED: Direct workflow failed!"
            exit 1
          fi

  summary:
    runs-on: ubuntu-latest
    needs: [test-reusable-workflow, test-direct-workflow]
    if: always()
    steps:
      - name: Report findings
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  GitHub Actions Environment Secret Bug - Test Results"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "### ğŸ” Key Finding"
          echo ""
          echo "The bug ONLY affects REUSABLE workflows (workflow_call)!"
          echo "Direct workflows work fine with the same ternary expression."
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "### ğŸ“Š Test Results"
          echo ""
          echo "Reusable Workflow Test:"
          echo "  Result: ${{ needs.test-reusable-workflow.result }}"
          if [ "${{ needs.test-reusable-workflow.result }}" = "failure" ]; then
            echo "  Status: âŒ Bug confirmed in reusable workflow"
          else
            echo "  Status: âœ… Works (bug may be fixed)"
          fi
          echo ""
          echo "Direct Workflow Test:"
          echo "  Result: ${{ needs.test-direct-workflow.result }}"
          if [ "${{ needs.test-direct-workflow.result }}" = "success" ]; then
            echo "  Status: âœ… Direct workflows work correctly"
          else
            echo "  Status: âŒ Unexpected failure"
          fi
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "### ğŸ› Bug Specifics"
          echo ""
          echo "Affected: REUSABLE workflows (on: workflow_call)"
          echo "Not Affected: Direct workflows (on: pull_request, push, etc.)"
          echo ""
          echo "Expression: suite == 'object_storage' && SECRET_A || SECRET_B"
          echo "  When suite='object_storage': âœ… Works (LEFT side)"
          echo "  When suite='networking': âŒ Fails (RIGHT side returns empty)"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
