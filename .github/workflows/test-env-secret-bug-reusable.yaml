---
name: Test Environment Secret Bug (Reusable Workflow)

# This is the REUSABLE workflow that will demonstrate the bug
# It's called by test-env-secret-bug-caller.yaml

'on':
  workflow_call:
    inputs:
      suite:
        description: 'Test suite (use "object_storage" or "networking")'
        required: true
        type: string

jobs:
  test-environment-secret-ternary:
    runs-on: cw
    container: ghcr.io/coreweave/github-actions-images/github-base-runner:v1.15.0
    environment: QA
    env:
      # This works - environment VARIABLE with ternary operator
      TEST_ENDPOINT: ${{ inputs.suite == 'object_storage' && secrets.COREWEAVE_OBJS_API_ENDPOINT || vars.COREWEAVE_API_ENDPOINT }}

      # This FAILS in reusable workflows when using RIGHT side (networking)
      TEST_TOKEN: ${{ inputs.suite == 'object_storage' && secrets.COREWEAVE_OBJS_API_TOKEN || secrets.COREWEAVE_API_TOKEN }}

    steps:
      - name: Test ternary operator with environment secrets (REUSABLE WORKFLOW)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Testing suite: ${{ inputs.suite }} (in REUSABLE workflow)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          echo "ğŸ“‹ This is a REUSABLE workflow (workflow_call)"
          echo "   The bug ONLY appears in reusable workflows!"
          echo ""

          echo "ğŸ“Š Results:"
          echo ""
          echo "Environment VARIABLE (TEST_ENDPOINT):"
          if [ -n "$TEST_ENDPOINT" ]; then
            echo "  Set: âœ… YES"
            echo "  Length: ${#TEST_ENDPOINT} chars"
          else
            echo "  Set: âŒ NO"
          fi
          echo ""
          echo "Environment SECRET (TEST_TOKEN):"
          if [ -n "$TEST_TOKEN" ]; then
            echo "  Set: âœ… YES"
            echo "  Length: ${#TEST_TOKEN} chars"
          else
            echo "  Set: âŒ NO - EMPTY!"
            echo "  Length: 0 chars"
          fi
          echo ""

          # Validate results
          if [ "${{ inputs.suite }}" = "object_storage" ]; then
            if [ -z "$TEST_TOKEN" ]; then
              echo "âŒ UNEXPECTED: object_storage should work (LEFT side)"
              exit 1
            else
              echo "âœ… EXPECTED: object_storage works (LEFT side of ternary)"
            fi
          else
            if [ -z "$TEST_TOKEN" ]; then
              echo "âŒ BUG CONFIRMED in REUSABLE WORKFLOW!"
              echo ""
              echo "   Expression: false || secrets.COREWEAVE_API_TOKEN"
              echo "   Expected: secrets.COREWEAVE_API_TOKEN"
              echo "   Actual: (empty string)"
              echo ""
              echo "   This is the GitHub Actions reusable workflow bug!"
              exit 1
            else
              echo "âœ… UNEXPECTED: networking works in reusable workflow!"
              echo "   Bug may have been fixed by GitHub"
            fi
          fi
