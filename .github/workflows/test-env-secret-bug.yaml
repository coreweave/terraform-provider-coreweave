---
name: Test Environment Secret Bug

# This workflow demonstrates a GitHub Actions bug where environment secrets
# don't work properly in ternary expressions with the || operator in reusable workflows.
#
# Expected behavior: Both jobs should successfully access their respective secrets
# Actual behavior: The ternary expression with environment secrets returns empty
#
# Related to: https://github.com/actions/runner/issues/1490

'on':
  pull_request:
    paths:
      - '.github/workflows/test-env-secret-bug.yaml'
      - 'GITHUB_ACTIONS_SECRET_BUG.md'
  workflow_dispatch:
    inputs:
      suite:
        description: 'Test suite (use "object_storage" or "networking")'
        required: true
        default: 'networking'
        type: choice
        options:
          - networking
          - object_storage

jobs:
  # This job demonstrates the issue with BOTH cases:
  # 1. suite=networking: ternary should use COREWEAVE_API_TOKEN (RIGHT side) - FAILS âŒ
  # 2. suite=object_storage: ternary should use COREWEAVE_OBJS_API_TOKEN (LEFT side) - WORKS âœ…
  test-environment-secret-ternary:
    runs-on: cw
    container: ghcr.io/coreweave/github-actions-images/github-base-runner:v1.15.0
    environment: QA
    strategy:
      fail-fast: false
      matrix:
        suite: ['networking', 'object_storage']
    env:
      # This works - environment VARIABLE with ternary operator
      TEST_ENDPOINT: ${{ matrix.suite == 'object_storage' && secrets.COREWEAVE_OBJS_API_ENDPOINT || vars.COREWEAVE_API_ENDPOINT }}

      # This FAILS for 'networking' but WORKS for 'object_storage'
      # When suite='networking':
      #   'networking' == 'object_storage' -> false
      #   false && secrets.COREWEAVE_OBJS_API_TOKEN -> false
      #   false || secrets.COREWEAVE_API_TOKEN -> should be secrets.COREWEAVE_API_TOKEN
      #   BUT IT RETURNS EMPTY! âŒ
      #
      # When suite='object_storage':
      #   'object_storage' == 'object_storage' -> true
      #   true && secrets.COREWEAVE_OBJS_API_TOKEN -> secrets.COREWEAVE_OBJS_API_TOKEN
      #   (|| not evaluated) -> WORKS âœ…
      TEST_TOKEN: ${{ matrix.suite == 'object_storage' && secrets.COREWEAVE_OBJS_API_TOKEN || secrets.COREWEAVE_API_TOKEN }}

    steps:
      - name: Test ternary operator with environment secrets
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Testing suite: ${{ matrix.suite }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          echo "ğŸ“‹ Test Details:"
          echo "  Ternary expression: suite == 'object_storage' && OBJS_TOKEN || API_TOKEN"
          if [ "${{ matrix.suite }}" = "object_storage" ]; then
            echo "  Expected: Use COREWEAVE_OBJS_API_TOKEN (LEFT side of ||)"
          else
            echo "  Expected: Use COREWEAVE_API_TOKEN (RIGHT side of ||)"
          fi
          echo ""

          echo "ğŸ“Š Results:"
          echo ""
          echo "Environment VARIABLE (TEST_ENDPOINT):"
          echo "  Set: ${TEST_ENDPOINT:+âœ… YES}"
          echo "  Length: ${#TEST_ENDPOINT} chars"
          echo ""
          echo "Environment SECRET (TEST_TOKEN):"
          if [ -n "$TEST_TOKEN" ]; then
            echo "  Set: âœ… YES"
            echo "  Length: ${#TEST_TOKEN} chars"
          else
            echo "  Set: âŒ NO - EMPTY!"
            echo "  Length: 0 chars"
          fi
          echo ""

          # Validate results
          if [ "${{ matrix.suite }}" = "object_storage" ]; then
            if [ -z "$TEST_TOKEN" ]; then
              echo "âŒ UNEXPECTED: object_storage should work (uses LEFT side of ternary)"
              echo "   This suggests a broader issue with environment secrets"
              exit 1
            else
              echo "âœ… EXPECTED: object_storage works (uses LEFT side of ternary)"
              echo "   The left side of && returns the secret directly"
            fi
          else
            if [ -z "$TEST_TOKEN" ]; then
              echo "âŒ BUG CONFIRMED: networking fails (uses RIGHT side of ternary)"
              echo ""
              echo "   Expected: false || secrets.COREWEAVE_API_TOKEN"
              echo "            â†’ secrets.COREWEAVE_API_TOKEN"
              echo "   Actual:   (empty string)"
              echo ""
              echo "   This is the GitHub Actions environment secret bug!"
              exit 1
            else
              echo "âœ… UNEXPECTED: networking works!"
              echo "   If you see this, the bug may have been fixed by GitHub"
            fi
          fi

  # This job shows a working alternative approach
  test-explicit-conditional:
    runs-on: cw
    container: ghcr.io/coreweave/github-actions-images/github-base-runner:v1.15.0
    environment: QA
    strategy:
      fail-fast: false
      matrix:
        suite: ['networking', 'object_storage']
    steps:
      - name: Set token for object_storage
        if: matrix.suite == 'object_storage'
        run: echo "TEST_TOKEN=${{ secrets.COREWEAVE_OBJS_API_TOKEN }}" >> $GITHUB_ENV

      - name: Set token for non-object_storage
        if: matrix.suite != 'object_storage'
        run: echo "TEST_TOKEN=${{ secrets.COREWEAVE_API_TOKEN }}" >> $GITHUB_ENV

      - name: Verify token is set (Workaround)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Workaround test for suite: ${{ matrix.suite }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Using explicit if/then conditionals instead of ternary operator"
          echo ""
          if [ -z "$TEST_TOKEN" ]; then
            echo "âŒ Token is empty (this shouldn't happen with explicit conditionals)"
            exit 1
          else
            echo "âœ… Token is correctly set with explicit conditionals"
            echo "   Length: ${#TEST_TOKEN} chars"
            echo ""
            echo "This approach works for both suites!"
          fi

  # Summary job to explain findings
  summary:
    runs-on: ubuntu-latest
    needs: [test-environment-secret-ternary, test-explicit-conditional]
    if: always()
    steps:
      - name: Report findings
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  GitHub Actions Environment Secret Bug - Test Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "### ğŸ” What This Tests"
          echo ""
          echo "Ternary expression: suite == 'object_storage' && SECRET_A || SECRET_B"
          echo ""
          echo "For suite='object_storage':"
          echo "  â†’ true && SECRET_A || SECRET_B"
          echo "  â†’ SECRET_A (LEFT side)"
          echo "  â†’ Expected: âœ… WORKS (gets evaluated directly)"
          echo ""
          echo "For suite='networking':"
          echo "  â†’ false && SECRET_A || SECRET_B"
          echo "  â†’ false || SECRET_B"
          echo "  â†’ SECRET_B (RIGHT side)"
          echo "  â†’ Expected: âœ… Should work"
          echo "  â†’ Actual: âŒ FAILS (returns empty string)"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "### ğŸ“Š Test Results"
          echo ""

          TERNARY_RESULT="${{ needs.test-environment-secret-ternary.result }}"
          WORKAROUND_RESULT="${{ needs.test-explicit-conditional.result }}"

          echo "Test 1: Ternary operator with environment secrets"
          if [ "$TERNARY_RESULT" = "failure" ]; then
            echo "  Result: âŒ FAILED (as expected - demonstrates the bug)"
            echo "  Status: This confirms the GitHub Actions bug exists"
          elif [ "$TERNARY_RESULT" = "success" ]; then
            echo "  Result: âœ… PASSED (unexpected!)"
            echo "  Status: Bug may have been fixed by GitHub!"
          else
            echo "  Result: âš ï¸  $TERNARY_RESULT"
          fi
          echo ""

          echo "Test 2: Explicit conditionals workaround"
          if [ "$WORKAROUND_RESULT" = "success" ]; then
            echo "  Result: âœ… PASSED"
            echo "  Status: Workaround functions correctly"
          else
            echo "  Result: âŒ FAILED"
            echo "  Status: Even the workaround doesn't work - investigate!"
          fi
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "### ğŸ› Bug Description"
          echo ""
          echo "Environment secrets fail to evaluate on the RIGHT side of the ||"
          echo "operator in ternary expressions, returning empty string instead."
          echo ""
          echo "Key findings:"
          echo "  â€¢ Environment VARIABLES work fine: âœ…"
          echo "  â€¢ Environment SECRETS on LEFT side: âœ… (when condition is true)"
          echo "  â€¢ Environment SECRETS on RIGHT side: âŒ (when condition is false)"
          echo "  â€¢ Repository secrets work fine: âœ…"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "### ğŸ’¡ Workaround"
          echo ""
          echo "Instead of:"
          echo "  env:"
          echo "    TOKEN: $ {{ condition && SECRET_A || SECRET_B }}"
          echo ""
          echo "Use:"
          echo "  steps:"
          echo "    - if: condition"
          echo "      run: echo \"TOKEN=\$ {{ SECRET_A }}\" >> \$GITHUB_ENV"
          echo "    - if: '!condition'"
          echo "      run: echo \"TOKEN=\$ {{ SECRET_B }}\" >> \$GITHUB_ENV"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "### ğŸ”— Related GitHub Issues"
          echo ""
          echo "  â€¢ https://github.com/actions/runner/issues/1490"
          echo "  â€¢ https://github.com/actions/runner/issues/3379"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
